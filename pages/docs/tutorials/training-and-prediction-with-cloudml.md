tags: tutorial, popular, intro

# Training and prediction with Cloud ML

[TOC]

In this tutorial, we'll train a model with Google's Cloud Machine
Learning Engine (Cloud ML) and use the trained model to make
prediction.

This tutorial mirrors the steps [Cloud ML Engine - Getting Started
->](https://cloud.google.com/ml-engine/docs/getting-started-training-prediction) and trains

## Requirements

This tutorial assumes the following:

- Guild AI is [installed and verified](/install)
- [Google Cloud SDK ->](https://cloud.google.com/sdk/docs/) is installed
- Your [virtual environment is activated](alias:virtualenv-activate)
  (if applicable)
- You have a working Internet connection

While not required, we recommend using a dedicated virtual environment
for this tutorial. To setup your environment, see
[](alias:tut-env-setup).

## Install the Cloud ML Census

We'll be training a model in the `cloudml.census` package. From a
command line, run:

``` command
guild install cloudml.census
```

You can list the model operations available from the package by
running:

``` command
guild ops cloudml.census
```

``` output
cloudml.census/census-dnn:cloudml-train  Train the classifier on Cloud ML
cloudml.census/census-dnn:train          Train the model locally
```

## Train the model locally

Train the classifier locally by running:

``` command
guild train census train-steps=1000
```

Guild will display the flags that will be used in the operation. Note
that we'll be training for 1000 steps. This isn't a lot, so we'll get
through the training quickly.

Press `ENTER` to start training.

Guild will run the training script, which should finish on most
systems in under a minute or two.

## View the training results

The training run generated a number of files. We can view them by
running:

``` command
guild runs info --files
```

This commands shows run info for the latest run. The ``--files``
option tells Guild to include file information in the output.

Let's briefly look at the files:

`census-data/`
: Link to census data used for training and test

`checkpoint`
: Latest TensorFlow checkpoint marker

`eval_census-eval/events.out.tfevents.*.omaha`
: TensorFlow event log generated during evaluation

`events.out.tfevents.*.omaha`
: TensorFlow event log generated during training

`export/census/*/saved_model.pb`
: TensorFlow SavedModel

`export/census/*/variables/`
: TensorFlow variables

`graph.pbtxt`
: TensorFlow GraphDef

`model.ckpt-1.*`
: TensorFlow checkpoint at training step 1

`model.ckpt-1000.*`
: TensorFlow checkpoint at training step 1000

`trainer`
: Link to training scripts

We can also use Guild View to view this information. In a
[](alias:separate-console), run:

``` command
guild view -o census
```

This opens a browser window showing you the list of runs for the
census classifier. You can see the list of files for a run by clicking
the **FILES** tab.

You can additionally view the TensorFlow logs by clicking ![View in
TensorBoard](/assets/img/view-in-tensorboard.png) in the upper left of
Guild View.

Keep these windows open as they will automatically update as you
generate more runs.

Note in TensorBoard the model **accuracy**, which can be viewed under
the **SCALARS** tab. The value for our first run should be around 80%.

## Train the model in Cloud ML

Next we'll train the classifier in Cloud ML.

When training in Cloud ML, you need to first create a Cloud Storage
bucket. This will contain the runs generated by Guild.

For instructions, see [Set up your Cloud Storage bucket
->](https://cloud.google.com/ml-engine/docs/getting-started-training-prediction#set_up_your_cloud_storage_bucket)
in the Cloud ML Getting Started guide.

Verify that you can use `gsutil` to list the contents of your bucket:

``` command
guild gsutil ls BUCKET
```

where ``BUCKET`` is the name of the bucket you will use for Cloud ML
training runs.

To train the census classifier in Cloud ML, use the `cloudml-train`
operation:

``` command
guild run census:cloudml-train bucket-name=BUCKET train-steps=1000
```

Replace ``BUCKET`` with the name of the bucket you created earlier.

!!! note
    In our previous training we ran ``guild train census``. This is
    because Guild provides an [operation alias](term:operation-alias)
    for the `train` operation. When training on Cloud ML, we run the
    `cloudml-train` operation, which doesn't have an alias. We
    therefore need to use the `run` command with an explicit operation
    name.

The `cloudml-train` operation is identical to the `train` operation,
but it is run remotely on Cloud ML rather than locally.

The operation will take longer to run because Cloud ML must first
provision a job and wait for TensorFlow to start remotely. This can
take several minutes or more. You can view the run status as it
progresses in the command line console. You can also view status and
log updates from Guild View and TensorBoard.

Guild will routinely synchronize its run status with the remote
job. You can view the updated status in Guild View.

If Guild becomes disconnected from the remote job --- e.g. you
terminate the command or lose network connectivity --- the job will
still run in Cloud ML. You can synchornize the run status using the
[](cmd:sync) command. If you'd like to reconnect to the running job to
view its logs as they're written, use the ``--watch`` option with the
command as follows:

```
guild sync --watch
```

## Compare runs

Use the [](cmd:compare) command to view your training accuracies for
the two runs:

``` command
guild compare
```

If a run is still in process (i.e. its status is ``running``) you can
press ``r`` to refresh the comparison with the latest accuracies and
loss.

For a complete list of commands supported by the compare view, press
``?``.

To exit the comparison view, press ``q``.

You can export the current comparison view as comma separted list of
values by running:

``` command
guild compare --csv
```

You can also compare individual scalar statistics using
TensorBoard. If you have TensorBoard in a browser window from earlier,
it will automatically refresh to display the current training
results. If you need to restart Guild View, run:

``` command
guild view
```

Click **VIEW IN TENSORBOARD** to open TensorBoard.

You can alternatively open TensorBoard directly using the [](cmd:tensorboard) command:

```
guild tensorboard
```
